// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Connection pooling for better performance under load
  // Supports up to 20 concurrent connections per instance
}

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String    @map("password_hash")
  salt                String
  status              String    @default("alive") // alive, missed_one, missed_two, escalation, pending_unlock, unlocked
  lastCheckIn         DateTime? @map("last_check_in")
  nextCheckIn         DateTime? @map("next_check_in")
  checkInIntervalDays Int       @default(90) @map("check_in_interval_days")
  gracePeriodEnd      DateTime? @map("grace_period_end")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  vault           Vault?
  trustedContacts TrustedContact[]
  checkIns        CheckIn[]
  auditLogs       AuditLog[]
  subscriptions   Subscription[]
  notifications   Notification[]
  people          Person[]
  legacyPolicy    LegacyPolicy?

  @@index([status])
  @@index([nextCheckIn])
  @@map("users")
}

model Vault {
  id                  String   @id @default(uuid())
  userId              String   @unique @map("user_id")
  encryptedVmk        String   @map("encrypted_vmk")
  vmkSalt             String   @map("vmk_salt")
  storageUsedBytes    BigInt   @default(0) @map("storage_used_bytes")
  storageLimitBytes   BigInt   @default(10737418240) @map("storage_limit_bytes") // 10GB
  uploadCountThisWeek Int      @default(0) @map("upload_count_this_week")
  uploadLimitWeekly   Int      @default(3) @map("upload_limit_weekly")
  tier                String   @default("starter") // starter, family, unlimited, lifetime
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  items          VaultItem[]
  recipients     Recipient[]
  unlockRequests UnlockRequest[]
  uploadBonuses  UploadBonus[]

  @@map("vaults")
}

enum Visibility {
  PRIVATE
  POSTHUMOUS
}

model VaultItem {
  id                String     @id @default(uuid())
  vaultId           String     @map("vault_id")
  type              String // photo, video, letter, voice, document, wisdom
  title             String?
  encryptedData     String     @map("encrypted_data")
  encryptedDek      String     @map("encrypted_dek")
  thumbnailUrl      String?    @map("thumbnail_url")
  fileSizeBytes     BigInt?    @map("file_size_bytes")
  recipientIds      String[]   @map("recipient_ids")
  scheduledDelivery DateTime?  @map("scheduled_delivery")
  emotionCategory   String?    @map("emotion_category")
  importanceScore   Int        @default(5) @map("importance_score")
  sentimentScore    Float?     @map("sentiment_score")
  sentimentLabel    String?    @map("sentiment_label") // happy, sad, angry, neutral, joyful, nostalgic
  keywords          String[]   @default([])
  aiSummary         String?    @map("ai_summary")
  entities          Json?
  visibility        Visibility @default(PRIVATE)
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  vault  Vault          @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  people MemoryPerson[]

  @@index([vaultId])
  @@index([vaultId, createdAt])
  @@index([scheduledDelivery])
  @@index([emotionCategory])
  @@index([importanceScore])
  @@index([keywords])
  @@index([visibility])
  @@index([sentimentLabel])
  @@map("vault_items")
}

model Recipient {
  id               String    @id @default(uuid())
  vaultId          String    @map("vault_id")
  email            String
  name             String?
  relationship     String?
  accessLevel      String    @default("specific") // full, partial, specific
  publicKey        String?   @map("public_key")
  notificationSent Boolean   @default(false) @map("notification_sent")
  accessToken      String?   @map("access_token")
  accessExpiresAt  DateTime? @map("access_expires_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@index([vaultId])
  @@index([vaultId, createdAt])
  @@map("recipients")
}

model TrustedContact {
  id                   String    @id @default(uuid())
  userId               String    @map("user_id")
  email                String
  phone                String?
  name                 String?
  shamirShareEncrypted String?   @map("shamir_share_encrypted")
  verificationStatus   String    @default("pending") @map("verification_status") // pending, verified
  verificationToken    String?   @map("verification_token")
  confirmedDeath       Boolean   @default(false) @map("confirmed_death")
  confirmedAt          DateTime? @map("confirmed_at")
  createdAt            DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@map("trusted_contacts")
}

model CheckIn {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  sentAt         DateTime  @map("sent_at")
  sentVia        String?   @map("sent_via") // email, sms
  respondedAt    DateTime? @map("responded_at")
  responseMethod String?   @map("response_method") // link_click, email_reply, sign_in
  missed         Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@map("check_ins")
}

model UnlockRequest {
  id                 String    @id @default(uuid())
  vaultId            String    @map("vault_id")
  initiatedBy        String    @map("initiated_by")
  status             String    @default("pending") // pending, approved, cancelled
  confirmationsCount Int       @default(0) @map("confirmations_count")
  gracePeriodEnd     DateTime? @map("grace_period_end")
  createdAt          DateTime  @default(now()) @map("created_at")
  completedAt        DateTime? @map("completed_at")

  vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@map("unlock_requests")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@map("audit_log")
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String    @map("user_id")
  stripeCustomerId     String?   @map("stripe_customer_id")
  stripeSubscriptionId String?   @map("stripe_subscription_id")
  tier                 String
  status               String    @default("active") // active, cancelled, past_due
  currentPeriodEnd     DateTime? @map("current_period_end")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model UploadBonus {
  id          String    @id @default(uuid())
  vaultId     String    @map("vault_id")
  bonusType   String?   @map("bonus_type") // birthday, referral, annual_payment
  bonusAmount Int?      @map("bonus_amount")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@map("upload_bonuses")
}

model Notification {
  id        BigInt    @id @default(autoincrement())
  userId    String    @map("user_id")
  type      String
  title     String?
  body      String?
  actionUrl String?   @map("action_url")
  metadata  Json?
  priority  Int       @default(0)
  createdAt DateTime  @default(now()) @map("created_at")
  seenAt    DateTime? @map("seen_at")
  readAt    DateTime? @map("read_at")
  expiresAt DateTime? @map("expires_at")
  dedupeKey String?   @map("dedupe_key")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dedupeKey])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, readAt])
  @@index([userId, seenAt])
  @@index([userId, expiresAt])
  @@map("notifications")
}

enum Relation {
  self
  father
  mother
  son
  daughter
  spouse
  sibling
  grandparent
  grandchild
  aunt_uncle
  cousin
  friend
  other
}

model Person {
  id        String    @id @default(uuid())
  ownerId   String    @map("owner_id")
  name      String
  relation  Relation
  birthDate DateTime? @map("birth_date")
  deathDate DateTime? @map("death_date")
  notes     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  owner    User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  memories MemoryPerson[]

  @@index([ownerId])
  @@index([ownerId, relation])
  @@map("people")
}

model MemoryPerson {
  memoryId String  @map("memory_id")
  personId String  @map("person_id")
  primary  Boolean @default(false)

  memory VaultItem @relation(fields: [memoryId], references: [id], onDelete: Cascade)
  person Person    @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@id([memoryId, personId])
  @@index([personId])
  @@map("memory_people")
}

model LegacyPolicy {
  id              String   @id @default(uuid())
  ownerId         String   @unique @map("owner_id")
  rules           Json // {defaultUnlockGroup, includePeopleIds, excludePeopleIds, memoryFilters}
  gracePeriodDays Int      @default(14) @map("grace_period_days")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("legacy_policies")
}

model Comment {
  id        String   @id @default(uuid())
  itemId    String   @map("item_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  reactions CommentReaction[]

  @@index([itemId])
  @@index([itemId, createdAt])
  @@map("comments")
}

model CommentReaction {
  id        String   @id @default(uuid())
  commentId String   @map("comment_id")
  userId    String   @map("user_id")
  type      String // heart, thumbs_up, smile, etc.
  createdAt DateTime @default(now()) @map("created_at")

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, type])
  @@index([commentId])
  @@map("comment_reactions")
}

model Highlight {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  description String?
  memoryIds   String[] @map("memory_ids")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, createdAt])
  @@map("highlights")
}

model TimeCapsule {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  title      String
  message    String
  memoryIds  String[] @map("memory_ids")
  unlockDate DateTime @map("unlock_date")
  isLocked   Boolean  @default(true) @map("is_locked")
  recipients String[] @default([])
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, unlockDate])
  @@map("time_capsules")
}

model ImportJob {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  source     String // local, google_photos, icloud, etc.
  total      Int      @default(0)
  processed  Int      @default(0)
  duplicates Int      @default(0)
  imported   Int      @default(0)
  status     String   @default("pending") // pending, processing, completed, failed
  settings   Json?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, status])
  @@map("import_jobs")
}

model AnalyticsEvent {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  event      String
  properties Json?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([event, createdAt])
  @@index([createdAt])
  @@map("analytics_events")
}
