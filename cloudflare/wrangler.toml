# Heirloom - Cloudflare Workers Configuration
# https://heirloom.blue

name = "heirloom-api"
main = "worker/src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Account settings
account_id = "08596e523c096f04b56d7ae43f7821f4"

# ============================================
# BINDINGS
# ============================================

# D1 Database (SQLite at the edge)
[[d1_databases]]
binding = "DB"
database_name = "heirloom-db"
database_id = "4a228f5e-5ab9-4337-80d7-ebdb4eca0b7d"

# R2 Storage (S3-compatible, zero egress)
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "heirloom-uploads"

# KV Namespace (for sessions, cache)
[[kv_namespaces]]
binding = "KV"
id = "a95e2aeaffd14f7f8c28ed9645d81b48"

# Durable Objects (for real-time features)
[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiter"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["RateLimiter"]

# ============================================
# CRON TRIGGERS (Dead Man's Switch)
# ============================================

# Cron triggers for Dead Man's Switch
# NOTE: Set CRON_ENABLED=true via `wrangler secret put CRON_ENABLED` to activate
[triggers]
crons = [
  "0 9 * * *",   # Daily at 9 AM UTC - check for missed check-ins
  "0 0 * * 0",   # Weekly on Sunday - send reminder emails
  "0 */12 * * *", # Every 12 hours - regenerate AI prompts cache
]

# ============================================
# ENVIRONMENT VARIABLES
# ============================================

[vars]
ENVIRONMENT = "production"
APP_URL = "https://heirloom.blue"
API_URL = "https://api.heirloom.blue"
ADMIN_NOTIFICATION_EMAIL = "reshigan@vantax.co.za"

# Secrets (set via `wrangler secret put`)
# - JWT_SECRET
# - STRIPE_SECRET_KEY
# - STRIPE_WEBHOOK_SECRET
# - RESEND_API_KEY (for emails)
# - ENCRYPTION_MASTER_KEY

# ============================================
# ENVIRONMENTS
# ============================================

[env.staging]
name = "heirloom-api-staging"
vars = { ENVIRONMENT = "staging", APP_URL = "https://staging.heirloom.blue" }

[[env.staging.d1_databases]]
binding = "DB"
database_name = "heirloom-db-staging"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# [[env.staging.r2_buckets]]
# binding = "STORAGE"
# bucket_name = "heirloom-uploads-staging"

[[env.staging.kv_namespaces]]
binding = "KV"
id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

[env.development]
name = "heirloom-api-dev"
vars = { ENVIRONMENT = "development", APP_URL = "http://localhost:3000" }

# ============================================
# BUILD & DEPLOY
# ============================================

# [build]
# command = "npm run build"

# Custom domain routes
routes = [
  { pattern = "api.heirloom.blue/*", zone_id = "4f33448ad768746ae4f365abde120f0d" }
]

# Tail workers for logging
# [tail_consumers]
# service = "heirloom-logger"
