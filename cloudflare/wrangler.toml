# Heirloom - Cloudflare Workers Configuration
# https://heirloom.blue

name = "heirloom-api"
main = "worker/src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Account settings (replace with your values)
# account_id = "your-account-id"

# ============================================
# BINDINGS
# ============================================

# D1 Database (SQLite at the edge)
[[d1_databases]]
binding = "DB"
database_name = "heirloom-db"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"  # Replace after creation

# R2 Storage (S3-compatible, zero egress)
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "heirloom-uploads"

# KV Namespace (for sessions, cache)
[[kv_namespaces]]
binding = "KV"
id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"  # Replace after creation

# Durable Objects (for real-time features)
[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiter"

[[migrations]]
tag = "v1"
new_classes = ["RateLimiter"]

# ============================================
# CRON TRIGGERS (Dead Man's Switch)
# ============================================

[triggers]
crons = [
  "0 9 * * *",   # Daily at 9 AM UTC - check for missed check-ins
  "0 0 * * 0",   # Weekly on Sunday - send reminder emails
]

# ============================================
# ENVIRONMENT VARIABLES
# ============================================

[vars]
ENVIRONMENT = "production"
APP_URL = "https://heirloom.blue"
API_URL = "https://api.heirloom.blue"

# Secrets (set via `wrangler secret put`)
# - JWT_SECRET
# - STRIPE_SECRET_KEY
# - STRIPE_WEBHOOK_SECRET
# - RESEND_API_KEY (for emails)
# - ENCRYPTION_MASTER_KEY

# ============================================
# ENVIRONMENTS
# ============================================

[env.staging]
name = "heirloom-api-staging"
vars = { ENVIRONMENT = "staging", APP_URL = "https://staging.heirloom.blue" }

[[env.staging.d1_databases]]
binding = "DB"
database_name = "heirloom-db-staging"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

[[env.staging.r2_buckets]]
binding = "STORAGE"
bucket_name = "heirloom-uploads-staging"

[[env.staging.kv_namespaces]]
binding = "KV"
id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

[env.development]
name = "heirloom-api-dev"
vars = { ENVIRONMENT = "development", APP_URL = "http://localhost:3000" }

# ============================================
# BUILD & DEPLOY
# ============================================

[build]
command = "npm run build"

# Custom domain routes
# routes = [
#   { pattern = "api.heirloom.blue", custom_domain = true }
# ]

# Tail workers for logging
# [tail_consumers]
# service = "heirloom-logger"
